<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2016-03-21
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20160321" />
    <meta http-equiv="Content-Language" content="en" />
    <title>spf4j &#x2013; Spf4j (Simple performance framework for java)</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>SPF4J</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2016-03-21</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 7.2.24-SNAPSHOT</li>
                      
                
                    
      
                                              
    <li class="pull-right">              <a href="./" title="SPF4J">
        SPF4J</a>
  </li>

                        </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Main Menu</li>
                                
      <li class="active">
    
            <a href="#"><i class="none"></i>Introduction</a>
          </li>
                  
      <li>
    
                          <a href="http://code.google.com/p/spf4j/downloads/list" class="externalLink" title="Download">
          <i class="none"></i>
        Download</a>
            </li>
                              <li class="nav-header">Modules</li>
                                
      <li>
    
                          <a href="spf4j-asm/index.html" title="spf4j-asm">
          <i class="none"></i>
        spf4j-asm</a>
            </li>
                  
      <li>
    
                          <a href="spf4j-core/index.html" title="spf4j-core">
          <i class="none"></i>
        spf4j-core</a>
            </li>
                  
      <li>
    
                          <a href="spf4j-jmh/index.html" title="spf4j-jmh">
          <i class="none"></i>
        spf4j-jmh</a>
            </li>
                  
      <li>
    
                          <a href="spf4j-ui/index.html" title="spf4j-ui">
          <i class="none"></i>
        spf4j-ui</a>
            </li>
                  
      <li>
    
                          <a href="spf4j-aspects/index.html" title="spf4j-aspects">
          <i class="none"></i>
        spf4j-aspects</a>
            </li>
                  
      <li>
    
                          <a href="spf4j-zel/index.html" title="spf4j-zel">
          <i class="none"></i>
        spf4j-zel</a>
            </li>
                  
      <li>
    
                          <a href="spf4j-benchmarks/index.html" title="spf4j-benchmarks">
          <i class="none"></i>
        spf4j-benchmarks</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                      
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-down"></i>
        Project Information</a>
                    <ul class="nav nav-list">
                      
      <li>
    
                          <a href="integration.html" title="Continuous Integration">
          <i class="none"></i>
        Continuous Integration</a>
            </li>
                      
      <li>
    
                          <a href="dependency-convergence.html" title="Dependency Convergence">
          <i class="none"></i>
        Dependency Convergence</a>
            </li>
                      
      <li>
    
                          <a href="dependency-info.html" title="Dependency Information">
          <i class="none"></i>
        Dependency Information</a>
            </li>
                      
      <li>
    
                          <a href="distribution-management.html" title="Distribution Management">
          <i class="none"></i>
        Distribution Management</a>
            </li>
                      
      <li class="active">
    
            <a href="#"><i class="none"></i>About</a>
          </li>
                      
      <li>
    
                          <a href="issue-tracking.html" title="Issue Tracking">
          <i class="none"></i>
        Issue Tracking</a>
            </li>
                      
      <li>
    
                          <a href="license.html" title="Project License">
          <i class="none"></i>
        Project License</a>
            </li>
                      
      <li>
    
                          <a href="mail-lists.html" title="Mailing Lists">
          <i class="none"></i>
        Mailing Lists</a>
            </li>
                      
      <li>
    
                          <a href="modules.html" title="Project Modules">
          <i class="none"></i>
        Project Modules</a>
            </li>
                      
      <li>
    
                          <a href="plugin-management.html" title="Plugin Management">
          <i class="none"></i>
        Plugin Management</a>
            </li>
                      
      <li>
    
                          <a href="plugins.html" title="Project Plugins">
          <i class="none"></i>
        Project Plugins</a>
            </li>
                      
      <li>
    
                          <a href="team-list.html" title="Project Team">
          <i class="none"></i>
        Project Team</a>
            </li>
                      
      <li>
    
                          <a href="source-repository.html" title="Source Repository">
          <i class="none"></i>
        Source Repository</a>
            </li>
                      
      <li>
    
                          <a href="project-summary.html" title="Project Summary">
          <i class="none"></i>
        Project Summary</a>
            </li>
              </ul>
        </li>
                                                                                                                          
      <li>
    
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                            <form id="search-form" action="http://www.google.com/search" method="get" >
    
  <input value="$sitesearchValue" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr class="divider" />

           <div id="poweredBy">
                   
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

    
    <div class="g-plusone" data-href="http://www.spf4j.org" data-size="tall" ></div>

                   <div class="clear"></div>
                   
        
        
        
    <iframe src="http://www.facebook.com/plugins/like.php?href=http://www.spf4j.org&send=false&layout=box_count&show-faces=false&action=like&colorscheme=light"
        scrolling="no" frameborder="0"
        style="border:none; width:48px; height:63px; margin-top: 10px;" ></iframe>
               <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Spf4j (Simple performance framework for java)</h1>
<div class="section">
<h2><a name="a1._Overview"></a>1. Overview</h2>
<p>The spf4j library is a collection of utilities and components to monitor, troubleshoot and fix performance issues.  This library also contains useful general purpose utilities and components that are currently not available in  high quality form in other OS libraries (Retry utils, object pool&#x2026;)  This library also contains ZEL, a simple expression language that can be easily used in any java application.  Zel is easy to extend to your needs and also has some cool features like async functions, memorization&#x2026;  You can learn more by checking out the <a class="externalLink" href="http://www.spf4j.org/spf4j-zel/index.html">spf4j-zel</a> module.</p></div>
<div class="section">
<h2><a name="a2._License"></a>2. License</h2>
<p>This library is <a class="externalLink" href="http://www.gnu.org/licenses/lgpl.html">LGPL</a> licensed.</p>
<p>Contributions/Contributors to spf4j are welcome.</p>
<p>Articles about java, and this library are on my <a class="externalLink" href="http://blogs.zoltran.com">blog</a></p></div>
<div class="section">
<h2><a name="a3._Code_Binaries_Build"></a>3. Code, Binaries, Build</h2>
<p><a class="externalLink" href="https://github.com/zolyfarkas/spf4j/">SPF4J Github hosted repo</a></p>
<p>Look for latest releases <a class="externalLink" href="http://search.maven.org/#search|ga|1|spf4j">at</a></p>
<p>Download snapshot and release artifacts <a class="externalLink" href="https://oss.sonatype.org/content/groups/public">from</a></p>
<p>More info can be found on the <a class="externalLink" href="https://blogs.zoltran.com">blog</a></p>
<p><a class="externalLink" href="https://scan.coverity.com/projects/3158"><img src="https://scan.coverity.com/projects/3158/badge.svg" alt="Coverity Badge" /></a></p>
<p><a class="externalLink" href="https://travis-ci.org/zolyfarkas/spf4j"><img src="https://travis-ci.org/zolyfarkas/spf4j.svg?branch=master" alt="CI badge" /></a></p></div>
<div class="section">
<h2><a name="a4._Performance_monitoring"></a>4. Performance monitoring</h2>
<div class="section">
<h3><a name="a4.1._Why_not_use_jamon_metrics_netflix_servo_"></a>4.1. Why not use jamon, metrics, netflix servo ?</h3>
<p>Observing a system changes the system. The goal of this library is to minimize the observer effect.  The code in spf4j is carefully written to be as high performance as possible,  it should outperform all competing libraries on any modern JVM(implementing biased locking)  running on a CCNUMA system.</p></div>
<div class="section">
<h3><a name="a4.2._How_to_record_measurements"></a>4.2. How to record measurements?</h3>
<div class="section">
<h4><a name="a4.2.1_Via_API"></a>4.2.1 Via API</h4>

<ul>
  
<li>Low impact with log linear quantized recording for Gauge type of measurements:</li>
</ul>

<div class="source">
<div class="source">
<pre>private static final MeasurementRecorder recorder 
                     = RecorderFactory.createScalableQuantizedRecorder(forWhat, unitOfMeasurement,
                     sampleTime, factor, lowerMagnitude, higherMagnitude, quantasPerMagnitude);
&#x2026;
recorder.record(measurement);
</pre></div></div>
<p>This is ideal for recording execution times and provides the most detail.  (Min, max, avg, and detailed distribution heat chart)  If distribution chart is not needed createScalableMinMaxAvgRecorder is available with less overhead.</p>

<ul>
  
<li>Low impact with simple counting for Counters.</li>
</ul>

<div class="source">
<div class="source">
<pre>private static final MeasurementRecorder recorder 
                     = RecorderFactory.createScalableCountingRecorder(forWhat, unitOfMeasurement, sampleTimeMillis);
&#x2026;
recorder.record(measurement);
</pre></div></div>

<div class="source">
<div class="source">
<pre>This is ideal for measurements like bytesSent, bytesReceived.
</pre></div></div>

<ul>
  
<li>Dynamic with log linear quantized recording for Gauge type of measurements.</li>
</ul>

<div class="source">
<div class="source">
<pre>private static final MeasurementRecorderSource recorderSource
                    = RecorderFactory.createScalableQuantizedRecorderSource( forWhatCategory, unitOfMeasurement,
                      sampleTime, factor, lowerMagnitude, higherMagnitude, quantasPerMagnitude);
&#x2026;
recorderSource.getRecorder(forWhat).record(measurement)
</pre></div></div>

<div class="source">
<div class="source">
<pre>As with the low impact static recorders there are dynamic equivalents:
createScalableMinMaxAvgRecorderSource and createScalableCountingRecorderSource
</pre></div></div>
<p>You can also create a monitored callable and call it of pass it to a executor like :</p>

<div class="source">
<div class="source">
<pre>Callable&lt;?&gt; monitoredCallable = 
     performanceMonitoredCallable(recorderSource, warnMillis, errorMillis, callable, &quot;myCallable&quot;).call()
</pre></div></div></div>
<div class="section">
<h4><a name="a4.2.2_Via_Annotations"></a>4.2.2 Via Annotations</h4>
<p>Annotate a method you want to measure and monitor performance with the annotation:</p>

<div class="source">
<div class="source">
<pre>@PerformanceMonitor(warnThresholdMillis=1, errorThresholdMillis=100, recorderSource = RecorderSourceInstance.Rs5m.class)
</pre></div></div>
<p>Start your jvm with Aspectj(1.7.x if you use java 1.7 or 1.8.x if you use java 1.8) load time weaver:</p>

<div class="source">
<div class="source">
<pre>-javaagent:${project.build.directory}/lib/aspectjweaver-${aspectj.version}.jar
</pre></div></div>
<p>Make sure your aspectj config file (META-INF/aop.xml) contains:</p>

<div class="source">
<div class="source">
<pre>&lt;aspectj&gt;
&lt;aspects&gt;
&lt;aspect name=&quot;org.spf4j.perf.aspects.PerformanceMonitorAspect&quot;/&gt;
&lt;/aspects&gt;
&lt;weaver options=&quot;-verbose&quot;&gt;
    &lt;!-- make sure the classes you want to apply aspects to are included --&gt;
    &lt;include within=&quot;com..*&quot;/&gt;
    &lt;include within=&quot;org.spf4j.perf.aspects.PerformanceMonitorAspect&quot;/&gt;
&lt;/weaver&gt;
&lt;/aspectj&gt;
</pre></div></div>
<p>This will record the execution times of the annotated method,  and will also log (via spf4j) a message containing the call detail and execution time  if the warn or error thresholds are exceeded. Dynamic quantized recorder source is used.</p></div>
<div class="section">
<h4><a name="a4.2.3_Where_are_measurements_stored"></a>4.2.3 Where are measurements stored?</h4>
<p>You can configure where the measurements are stored via the &#x201c;perf.ms.config&#x201d; system property like:</p>

<div class="source">
<div class="source">
<pre>  -Dperf.ms.config=TSDB@/path/to/file.tsdb,TSDB_TXT@/path/to/file.tsdbtxt,GRAPHITE_UDP@1.1.1.1:8080,GRAPHITE_TCP@1.1.1.1:8080
</pre></div></div>
<p>TSDB - binary file format (this is the most efficient store)</p>
<p>TSDB_TXT - text format each line: groupname, timestamp millis, sampletime millis, measurementName1, measurementValue2, &#x2026;</p>
<p>GRAPHITE_UDP - Graphite UDP appender.</p>
<p>GRAPHITE_TCP - Graphite UDP appender.</p></div></div>
<div class="section">
<h3><a name="a4.3._How_to_see_the_recorded_measurements"></a>4.3. How to see the recorded measurements?</h3>
<p>** Via JMX </p>
<p>invoke org.spf4j.perf.impl.ms.tsdb.TSDBMeasurementStore/flush to flush all measurements from memory to disk.</p>
<p>invoke org.spf4j.perf.impl.ms.tsdb.TSDBMeasurementStore/getTableAsCsv to get the data from a particular tsdb table as csv.</p>
<p>invoke org.spf4j.perf.impl.ms.tsdb.TSDBMeasurementStore/writeTableAsCsv to write the data from a particular rsdb table to a csv file.</p>
<p>** spf4j-UI.</p>
<p>The recorded measurements are saved to a TSDB file. Use the library provided UI (spf4j-ui module) to open the file  and visualize the measurements.</p>
<p><img src="images/explorer-ui.png" alt="Explorer UI" /></p></div>
<div class="section">
<h3><a name="a4.4._How_does_it_work_"></a>4.4. How does it work ?</h3>
<p>Measurements are recorded and stored in the Thread local storage.  At scheduled intervals the measurements aare retrieved, aggregated and stored to a TSDB file.  Charts are generated using jfreechart library.  TSDB file can also be opened and measurements viewed with the library embeded UI.</p>

<div class="source">
<div class="source">
<pre>[Code context] ---record(value)---&gt; [Thread Local Storage] ----&gt; [Aggregator/Persister] -----&gt; [TSDB]

</pre></div></div></div>
<div class="section">
<h3><a name="a4.5_Export_any_object_attribute_or_operations_via_JMX"></a>4.5 Export any object attribute or operations via JMX</h3>
<p>You can annotate with @JmxExport getters and setters of a attribute or any other method  that you want to make available via JMX.  Here is what you need to do:</p>

<div class="source">
<div class="source">
<pre>    public static final class JmxTest {
            
        private volatile String stringVal;

        @JmxExport
        public String getStringVal() {
            return stringVal;
        }

        @JmxExport
        public void setStringVal(final String stringVal) {
            this.stringVal = stringVal;
        }
        
        private static volatile String testStr;

        @JmxExport
        public static String getTestStr() {
            return testStr;
        }

        public static void setTestStr(final String testStr) {
            JmxTest2.testStr = testStr;
        }     
        
    }
...
        // Create object
        JmxTest testObj = new JmxTest();
        // Expose object via JMX (JmxExport annotated methods)
        Registry.export(&quot;test&quot;, &quot;Test&quot;, testObj);

 
</pre></div></div></div></div>
<div class="section">
<h2><a name="a5._Performance_Profiling"></a>5. Performance Profiling</h2>
<div class="section">
<h3><a name="a5.1._Why_another_profiling_library"></a>5.1. Why another profiling library?</h3>
<p>It all started with Brendan Gregg&#x2019;s blog: <a class="externalLink" href="http://dtrace.org/blogs/brendan/2011/12/16/flame-graphs/">http://dtrace.org/blogs/brendan/2011/12/16/flame-graphs/</a> combined with a few hours of coding.  However since than more monitoring capability has been added to spf4j. Flame-graph visualization has been improved  to better see hot function calls&#x2026;  Aspects to monitor object allocation, network, file, memory, garbage collection usage have been added.  One of the main advantages of spf4j is that it can be easily be used for continuous profiling.  The captured profile data is persisted to ssdump files which can be opened and visualized with the spf4j UI.</p>
<p>Due to the use of Thread.getStackTraces() the profile data is safe point biased.  For more detail see: <a class="externalLink" href="http://sape.inf.usi.ch/sites/default/files/publication/pldi10.pdf">http://sape.inf.usi.ch/sites/default/files/publication/pldi10.pdf</a>,  <a class="externalLink" href="https://www.youtube.com/watch?v=Yg6_ulhwLw0">https://www.youtube.com/watch?v=Yg6_ulhwLw0</a>, <a class="externalLink" href="https://github.com/RichardWarburton/honest-profiler">https://github.com/RichardWarburton/honest-profiler</a></p></div>
<div class="section">
<h3><a name="a5.2._When_to_profile_your_code"></a>5.2. When to profile your code?</h3>
<p>I recommend to deploy your code with profiling turned on as much as you can.  In my case I have profiling data collection turned on in test/qa environments all the time. (with 100ms sampling interval). If you can afford to do it in PROD do it.  Another good time to profile your code is during your JMH (<a class="externalLink" href="http://openjdk.java.net/projects/code-tools/jmh/">http://openjdk.java.net/projects/code-tools/jmh/</a>) benchmarks.  A good practice is to have a benchmark module in your project, that will benchmark key functionality of your application.  These benchmarks will be run as part of your build process, and you can monitor the performance of your project with a  Jenkins JMH <a class="externalLink" href="https://github.com/blackboard/jmh-jenkins">plugin</a></p></div>
<div class="section">
<h3><a name="a5.3._How_to_profile_your_code"></a>5.3. How to profile your code?</h3>
<p>Add spf4j to your classpath and the following to your command line:</p>

<div class="source">
<div class="source">
<pre>${JAVA_HOME}/bin/java [your jvm args] org.spf4j.stackmonitor.Monitor -df [folder to write date] -dp [file prefix] -ss -si 100  -main [your app main class] -- [your app arguments]
</pre></div></div>
<p>This will start your application with profiling enabled, with a 100 ms sampling interval.  After the process ends reportFile.html will be generated with a graphic width of 600 pixels.  Profiling can also be enabled/disabled via JMX.</p>
<p>Supported arguments:</p>

<div class="source">
<div class="source">
<pre>Usage:
 -df [folder] : dump folder
 -dp [prefix] : dump file prefix
 -di N        : the stack dump to file interval in milliseconds
 -f VAL       : output to this file the perf report, format is HTML
 -main VAL    : the main class name
 -si N        : the stack sampling interval in milliseconds
 -ss          : start the stack sampling thread. (can also be done manually via jmx)
</pre></div></div>
<p>You can also run and control the profiler via its java API:</p>

<div class="source">
<div class="source">
<pre>    Sampler SAMPLER = new Sampler(SAMPLE_PERIOD_MSEC);
    SAMPLER.start();
    SAMPLER.stop();
    SampleNode collected = SAMPLER.getStackCollector().clear();
    Converter.saveToFile(fileName, collected);

</pre></div></div>
<p>If you want to profile your JMH benchmarks you can simply add the spf4j JMH profiler to your startup options:</p>

<div class="source">
<div class="source">
<pre>        Options opt = new OptionsBuilder()
                .include(&quot;.*&quot;)
                .addProfiler(JmhProfiler.class)
                .build();
         new Runner(opt).run();

</pre></div></div>
<p>The profiling measurements will be save to file into the current dir. They can be opened and analized with the spf4j-ui.</p>
<p>Spf4j contains also a JMH Profiler integration for Java Flight Recorder, to use it all you need to do is:</p>

<div class="source">
<div class="source">
<pre>        Options opt = new OptionsBuilder()
                .include(&quot;.*&quot;)
                .addProfiler(JmhFlightRecorderProfiler.class)
                .build();
         new Runner(opt).run();

</pre></div></div>
<p>Java flight recorder should not have the safe point bias that spf4j has, however java flight recorder is a commercial  feature that requires a license from Oracle for production use.  For production use spf4j profiler is a zero cost alternative, which due to its simplicity should be a more  reliable option as well.</p>
<p>THe Jmh integration is available in spf4j-jmh module:</p>

<div class="source">
<div class="source">
<pre>        &lt;dependency&gt;
            &lt;groupId&gt;org.spf4j&lt;/groupId&gt;
            &lt;artifactId&gt;spf4j-jmh&lt;/artifactId&gt;
            &lt;version&gt;...&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
</pre></div></div></div>
<div class="section">
<h3><a name="a5.4._How_to_see_the_profile_data"></a>5.4. How to see the profile data?</h3>
<p>After the program finishes it will write the data to the {{{./stackSample.html}stackSample.html}} file</p>
<p>If you have a server application running and you started it with stack sampling, by default every 1 hour  the collected stack data is dumped to the temp folder. You can also invoke Sampler.dumpToFile to dum the stack samples  at any time in your program allowing you to separate out samples at relevant times in your application.  You can load and visualize this data with the library embeded ui:</p>
<p><img src="images/spf4j-flame-graph.png" alt="Flame Graph" /></p>
<p>The classic flame graph visualization remains available. The explorer ui can be used to visualize the measurements  stored in the tsdb files. You can also export the measurements to csv format allowing you to analyze them with tools like excel.</p>
<p><img src="images/explorer-ui.png" alt="Explorer UI" /></p>
<p>in the UI you can filter certain stack traces by right clicking on them and using the filter option in the context menu.</p></div>
<div class="section">
<h3><a name="a5.5._How_does_it_work"></a>5.5. How does it work?</h3>
<p>A sampling thread is started and running in the background.  This thread uses Thread.getAllStackTraces() or the JVM MX beans (configurable) to get all stack traces for all threads.  Each sample is added to a tree that aggregates the stack trace data.</p></div>
<div class="section">
<h3><a name="a5.6._Monitoring_memory_allocations:"></a>5.6. Monitoring memory allocations:</h3>
<p>You will need to apply aspect org.spf4j.memorymonitor.AllocationMonitorAspect  to the code you want to monitor object allocations. This aspect will intercept all new objects calls in your code  and it will use performance monitoring described at chapter 4 to record the number and amount of allocations.  AspectJ load time weaving is not capable of intercepting allocations done inside rt.jar. You will have to apply your  aspect against rt.jar and create a new one and add it to the boot class path  in case you want to see all allocations.</p>
<p>Getting access to the data is same as described in chapter 4, you can do it over jmx,  or opening the tsdb file in the embeded ui:</p>
<p><img src="images/spf4j_allocations.png" alt="allocations" /></p>
<p>Allocations are classified based on the class where they are done. This allows you to quickly identify memory hogs.  In the chart above you can see how memory allocations happened, both byteSize and allocation count and what class.  Object size computation might be too much overhead, in that case you can disable it by system property setting:</p>

<div class="source">
<div class="source">
<pre>-Dperf.allocations.recordSize=false
</pre></div></div></div>
<div class="section">
<h3><a name="a5.7._Monitoring_Network_IO"></a>5.7. Monitoring Network IO</h3>
<p>The aspect org.spf4j.iomonitor.NetworkMonitorAspect will allow you to monitor you processes network traffic.</p>
<p><img src="images/spf4j_io.png" alt="network traffic" /> network traffic</p></div>
<div class="section">
<h3><a name="a5.8._Monitoring_Memory_Usage"></a>5.8. Monitoring Memory Usage</h3>
<p>By calling MemoryUsageSampler.startMemoryUsageSampling(sampleTime) memory usage will be sampled at the provided  interval. Sampled data ill be aggregated at the interval set by perf.memory.sampleAggMillis system property.  Data will be stored into a spf4j tsdb where data can be accessed via jmx or the sf4j ui.</p></div>
<div class="section">
<h3><a name="a5.9._Monitoring_File_Usage"></a>5.9. Monitoring File Usage</h3>
<p>By calling OpenFilesSampler.startFileUsageSampling(sampleTime, warnThreshold, errorThreshold),  file usage will be sampled at the provided interval. This is usefull to see open files trend and detect file handle  leaks, which will cause in general outages of your application. The warn and error threshold numbers will long  details provided by lsof to help you troubleshoot what is going on.  Sampled data will be aggregated at the interval set by perf.io.openFiles.sampleAggMillis system property.  Data will be stored into a spf4j tsdb where data can be accessed via jmx or the sf4j ui.</p></div></div>
<div class="section">
<h2><a name="a6._High_Performance_Object_Pool"></a>6. High Performance Object Pool</h2>
<div class="section">
<h3><a name="a6.1._Why_another_object_pool_implementation"></a>6.1. Why another object pool implementation?</h3>
<p>In my(I am not alone) view current available object pool implementations are less than perfect. Beside the scalability issues and bugs, I don&#x2019;t like the following implementation choices found in other implementations:</p>

<ul>
  
<li>
<p>
  </p>
<ol style="list-style-type: decimal">
    
<li>Test on borrow is pointless, there is no guarantee that you will get a valid object even if you test on borrow.  This encourages the developer to disregard handling of this case when it receives an invalid object.  This practice also often is a performance killer.</li>
  </ol></li>
  
<li>
  
<ol style="list-style-type: decimal">
    
<li>Indiscriminate test on return is not optimal either.  Test on return should be done only in the case where there is a suspicion that the object is invalid,  otherwise the performance impact will be too high to be acceptable in most cases.  Pool client should be able to provide feedback on return for that case.</li>
  </ol></li>
  
<li>
  
<ol style="list-style-type: decimal">
    
<li>NO exception swallowing.  If a exception happens with the pooled objects the pool user will know about it and will have to handle it.</li>
  </ol></li>
</ul>
<p>One of the most popular object pool implementations is apache commons-pool with dbcp-pool specialized  in JDBC object based on it. A lot of people are unhappy with this implementation (including myself),  so much that the apache tomcat developers wrote their own implementation.  Here is a comparison of their implementation against dbcp pool:</p>
<p><a class="externalLink" href="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html">http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html</a></p>
<p>A performance comparison between dbcp, c3p0, and tomcat jdbc pool :</p>
<p><a class="externalLink" href="http://www.tomcatexpert.com/blog/2010/03/22/understanding-jdbc-pool-performance-improvements">http://www.tomcatexpert.com/blog/2010/03/22/understanding-jdbc-pool-performance-improvements</a></p>
<p>The goal of this implementation is to be more reliable and faster than any of the implementations out there.</p></div>
<div class="section">
<h3><a name="a6.2._Use_case"></a>6.2. Use case</h3>
<p>The classical use case for an object pool is to pool your jdbc connections or any type of network connection.</p></div>
<div class="section">
<h3><a name="a6.3._How_to_use_the_object_pool"></a>6.3. How to use the object pool</h3>
<p>Creating a pool is simple:</p>

<div class="source">
<div class="source">
<pre>RecyclingSupplier&lt;ExpensiveTestObject&gt; pool = new RecyclingSupplierBuilder(10, new ExpensiveTestObjectFactory()).build();
</pre></div></div>
<p>at minimum you will need to provide the maximum size and the object factory.  To do something with a object from a pool you will need to:</p>

<div class="source">
<div class="source">
<pre>Template.doOnSupplied(new Handler&lt;PooledObject, SomeException&gt;() {
   @Override
   public void handle( PooledObject object, long deadline) throws SomeException {
   object.doStuff();
   }
}, pool, imediateRetries, maxBackoffDelay, timeout );
</pre></div></div>
<p>You can also use the get and recycle methods on the object pool to get and return an object to the pool.</p></div>
<div class="section">
<h3><a name="a6.4._How_does_the_pool_work"></a>6.4. How does the pool work?</h3>
<p>The architecture above biases object to threads, so a thread will most likely get the same object minimizing  object contention (if pool size &gt;= thread nr which is the recommended sizing). </p>

<div class="source">
<div class="source">
<pre>      [code context]  &lt;----&gt; [Thread Local Pool] &lt;----&gt; [Global Pool]                                                       
</pre></div></div>
<p>On the other hand this pool implementation will prefer to create a new connection  instead of reusing a connection that has already has been used by another thread.  This is alleviated by the maintenance process which can bring back unused local object to the global pool.</p></div></div>
<div class="section">
<h2><a name="a7._Other_utilities"></a>7. Other utilities</h2>
<p>Lifo Threadpool: org.spf4j.concurrent.LifoThreadPoolBuilder</p>
<p>Retry utility implementation: see org.spf4j.base.Callables and org.spf4j.concurrent.RetryExecutor</p>
<p>Union: see org.spf4j.base.Either</p>
<p>Unique ID and Scalable sequence generators: org.spf4j.concurrent.UIDgenerator and org.spf4j.concurrent.ScalableSequence </p>
<p>Csv: org.spf4j.io.Csv</p>
<p>IPC: org.spf4j.concurrent.FileBasedLock</p>
<p>Data Structures: org.spf4j.ds.RTree; org.spf4j.ds.Graph; org.spf4j.ds.UpdateablePriorityQueue </p>
<p>Process control: org.spf4j.base.Runtime</p>
<p>Object recyclers: org.spf4j.recyclable.impl.*</p>
<p>Concurrency: org.spf4j.io.PipedOutputStream</p>
<p>String performance utilities: org.spf4j.base.Strings</p>
<p>NIO TCP proxy server: org.spf4j.io.tcp.proxy.*</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                   2016.
          All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
