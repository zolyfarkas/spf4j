<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
	<TITLE></TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 3.4.1  (Unix)">
	<META NAME="AUTHOR" CONTENT="Zoltan  Farkas">
	<META NAME="CREATED" CONTENT="20121118;18535700">
	<META NAME="CHANGEDBY" CONTENT="Zoltan  Farkas">
	<META NAME="CHANGED" CONTENT="20130323;8353500">
	<STYLE TYPE="text/css">
	<!--
		@page { margin: 0.79in }
		P { margin-bottom: 0.08in }
		H1 { margin-bottom: 0.08in }
		H1.western { font-family: "Arial", sans-serif; font-size: 16pt }
		H1.cjk { font-family: "Arial Unicode MS"; font-size: 16pt }
		H1.ctl { font-family: "Arial Unicode MS"; font-size: 16pt }
		H2 { margin-bottom: 0.08in }
		H2.western { font-family: "Arial", sans-serif; font-size: 14pt; font-style: italic }
		H2.cjk { font-size: 14pt; font-style: italic }
		H2.ctl { font-family: "Arial Unicode MS"; font-size: 14pt; font-style: italic }
		H3 { margin-bottom: 0.08in }
		H3.western { font-family: "Arial", sans-serif }
		H3.ctl { font-family: "Arial Unicode MS" }
		A:link { so-language: zxx }
	-->
	</STYLE>
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<P STYLE="margin-bottom: 0in"><FONT SIZE=6 STYLE="font-size: 22pt"><B>Spf4j
(Simple performance framework for java)</B></FONT></P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<DIV ID="Table of Contents1" DIR="LTR">
	<DIV ID="Table of Contents1_Head" DIR="LTR">
		<P STYLE="margin-bottom: 0in; page-break-after: avoid"><FONT FACE="Arial, sans-serif"><FONT SIZE=4 STYLE="font-size: 16pt"><B>Table
		of Contents</B></FONT></FONT></P>
	</DIV>
	<P STYLE="margin-bottom: 0in"> 1.<A HREF="#__RefHeading__1565_175073954">Overview</A>	</P>
	<P STYLE="margin-bottom: 0in"> 2.<A HREF="#__RefHeading__1567_175073954">License</A>	</P>
	<P STYLE="margin-bottom: 0in"> 3.<A HREF="#__RefHeading__1569_175073954">Code</A>	</P>
	<P STYLE="margin-bottom: 0in"> 4.<A HREF="#__RefHeading__1421_175073954">Performance
	monitoring</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 4.1.<A HREF="#__RefHeading__1531_175073954">Why
	not use jamon, netflix servo ?</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 4.2.<A HREF="#__RefHeading__1533_175073954">How
	to record measurements?</A>	</P>
	<P STYLE="margin-left: 0.39in; margin-bottom: 0in"> a)<A HREF="#__RefHeading__1535_175073954">Via
	API</A>	</P>
	<P STYLE="margin-left: 0.39in; margin-bottom: 0in"> b)<A HREF="#__RefHeading__1537_175073954">Via
	Annotations.</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 4.3.<A HREF="#__RefHeading__1539_175073954">How
	to see the recorded measurements?</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 4.4.<A HREF="#__RefHeading__1541_175073954">How
	does it work ?</A>	</P>
	<P STYLE="margin-bottom: 0in"> 5.<A HREF="#__RefHeading__1423_175073954">Performance
	Profiling</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 5.1.<A HREF="#__RefHeading__1543_175073954">Why
	another profiling library?</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 5.2.<A HREF="#__RefHeading__1545_175073954">When
	to profile your code?</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 5.3.<A HREF="#__RefHeading__1547_175073954">How
	to profile your code?</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 5.4.<A HREF="#__RefHeading__1549_175073954">How
	to see the profile data?</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 5.5.<A HREF="#__RefHeading__1551_175073954">How
	does it work?</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 5.6.<A HREF="#__RefHeading__1553_175073954">Monitoring
	memory allocations:</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 5.7.<A HREF="#__RefHeading__1555_175073954">Monitoring
	Network IO</A>	</P>
	<P STYLE="margin-bottom: 0in"> 6.<A HREF="#__RefHeading__1425_175073954">High
	Performance Object Pool</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 6.1.<A HREF="#__RefHeading__1557_175073954">Why
	another object pool implementation?</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 6.2.<A HREF="#__RefHeading__1559_175073954">Use
	case</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 6.3.<A HREF="#__RefHeading__1561_175073954">How
	to use the object pool</A>	</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in"> 6.4.<A HREF="#__RefHeading__1563_175073954">How
	does the pool work?</A>	</P>
</DIV>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<H1 CLASS="western" STYLE="page-break-before: always"><A NAME="__RefHeading__1565_175073954"></A>
 1.Overview</H1>
<P>The spf4j library is a collection of utilities and components to
monitor, troubleshoot, performance issues. This library will also
contain high performance components not available in other open
source libraries.</P>
<H1 CLASS="western"><A NAME="__RefHeading__1567_175073954"></A> 2.License</H1>
<P>This library is LGPL licensed:
<A HREF="http://www.gnu.org/copyleft/lesser.html">http://www.gnu.org/copyleft/lesser.htm</A></P>
<H1 CLASS="western"><A NAME="__RefHeading__1569_175073954"></A> 3.Code</H1>
<P><A HREF="http://code.google.com/p/spf4j/">http://code.google.com/p/spf4j/</A></P>
<P><A HREF="https://github.com/zolyfarkas/spf4j">https://github.com/zolyfarkas/spf4j</A></P>
<H1 CLASS="western"><A NAME="__RefHeading__1421_175073954"></A> 4.Performance
monitoring</H1>
<H2 CLASS="western"><A NAME="__RefHeading__1531_175073954"></A> 4.1.Why
not use jamon, netflix servo ?</H2>
<P>Observing  a system changes the system. The goal of this library
is to minimize the observer effect. The code in spf4j is carefully
written to be as high performance as possible, it should outperform
all competing libraries on any modern JVM(implementing biased
locking) running on a CCNUMA system. 
</P>
<H2 CLASS="western"><A NAME="__RefHeading__1533_175073954"></A> 4.2.How
to record measurements?</H2>
<H3 CLASS="western"><A NAME="__RefHeading__1535_175073954"></A> a)Via
API</H3>
<P STYLE="margin-bottom: 0in">Low impact with log linear quantized
recording for Gauge type of measurements:</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-left: 0.51in; margin-bottom: 0in"><FONT COLOR="#0000ff"><FONT SIZE=2 STYLE="font-size: 9pt">private
static final MeasurementRecorder recorder =
RecorderFactory.createScalableQuantizedRecorder(forWhat,
	unitOfMeasurement, sampleTime, factor, lowerMagnitude,
higherMagnitude, quantasPerMagnitude);</FONT></FONT></P>
<P STYLE="margin-left: 0.51in; margin-bottom: 0in"><FONT COLOR="#0000ff">…</FONT></P>
<P STYLE="margin-left: 0.51in; margin-bottom: 0in"><FONT COLOR="#0000ff"><FONT SIZE=2 STYLE="font-size: 9pt">recorder.record(measurement);</FONT></FONT></P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in"><FONT COLOR="#000000"><FONT SIZE=2 STYLE="font-size: 9pt">This
is ideal for recording execution times and provides the most detail,
min, max, avg, and detailed distribution heat chart.</FONT></FONT></P>
<P STYLE="margin-bottom: 0in"><FONT COLOR="#000000"><FONT SIZE=2 STYLE="font-size: 9pt">If
distribution chart is not needed <B>createScalableMinMaxAvgRecorder
</B><SPAN STYLE="font-weight: normal">is available with less
overhead.</SPAN></FONT></FONT></P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in"><FONT COLOR="#000000"><FONT SIZE=3>Low
impact with simple counting for Counters:</FONT></FONT></P>
<P STYLE="margin-left: 0.51in; margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-left: 0.51in; margin-bottom: 0in"><FONT COLOR="#0000ff"><FONT SIZE=2 STYLE="font-size: 9pt">private
static final MeasurementRecorder recorder =
RecorderFactory.createScalableCountingRecorder(forWhat,
	unitOfMeasurement, sampleTimeMillis);</FONT></FONT></P>
<P STYLE="margin-left: 0.51in; margin-bottom: 0in"><FONT COLOR="#0000ff">…</FONT></P>
<P STYLE="margin-left: 0.51in; margin-bottom: 0in"><FONT COLOR="#0000ff"><FONT SIZE=2 STYLE="font-size: 9pt">recorder.record(measurement);</FONT></FONT></P>
<P STYLE="margin-left: 0.51in; margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in"><FONT COLOR="#000000"><FONT SIZE=2 STYLE="font-size: 9pt">This
is ideal for measurements like bytesSent, bytesReceived....</FONT></FONT></P>
<P STYLE="margin-left: 0.51in; margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in">Dynamic with log linear quantized
recording for Gauge type of measurements:</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-left: 0.51in; text-indent: -0.02in; margin-bottom: 0in">
<FONT COLOR="#0000ff"><FONT SIZE=2 STYLE="font-size: 9pt">private
static final MeasurementRecorderSource recorderSource  =
	RecorderFactory.createScalableQuantizedRecorderSource(
forWhatCategory, 					unitOfMeasurement, sampleTime, factor,
lowerMagnitude, higherMagnitude, quantasPerMagnitude);</FONT></FONT></P>
<P STYLE="margin-left: 0.5in; text-indent: 0.01in; margin-bottom: 0in">
<FONT COLOR="#0000ff"><FONT SIZE=2 STYLE="font-size: 9pt">	…</FONT></FONT></P>
<P STYLE="margin-left: 0.5in; text-indent: 0.01in; margin-bottom: 0in">
<FONT COLOR="#0000ff"><FONT SIZE=2 STYLE="font-size: 9pt">recorderSource.getRecorder(forWhat).record(measurement)</FONT></FONT></P>
<P STYLE="margin-left: 0.5in; text-indent: 0.01in; margin-bottom: 0in">
<BR>
</P>
<P STYLE="margin-bottom: 0in"><FONT COLOR="#000000"><FONT SIZE=2 STYLE="font-size: 9pt">As
with the low impact static recorders there are dynamic equivalents: 
</FONT><FONT SIZE=2 STYLE="font-size: 9pt"><B>createScalableMinMaxAvgRecorderSource
</B></FONT><FONT SIZE=2 STYLE="font-size: 9pt"><SPAN STYLE="font-weight: normal">and</SPAN></FONT><FONT SIZE=2 STYLE="font-size: 9pt"><B>
createScalableCountingRecorderSource</B></FONT></FONT></P>
<P STYLE="margin-left: 0.5in; text-indent: 0.01in; margin-bottom: 0in">
<BR>
</P>
<P STYLE="margin-left: 0.5in; text-indent: 0.01in; margin-bottom: 0in">
<BR>
</P>
<H3 CLASS="western"><A NAME="__RefHeading__1537_175073954"></A> b)Via
Annotations.</H3>
<P STYLE="margin-bottom: 0in">	Annotate a method you want to measure
and monitor performance with the annotation:</P>
<P STYLE="margin-bottom: 0in"> 
</P>
<P STYLE="margin-bottom: 0in"><FONT COLOR="#0000ff"><FONT SIZE=2 STYLE="font-size: 9pt">@PerformanceMonitor(warnThresholdMillis=1,
errorThresholdMillis=100, recorderSource =
RecorderSourceInstance.Rs5m.class)</FONT></FONT></P>
<P STYLE="margin-bottom: 0in">	</P>
<P STYLE="margin-bottom: 0in">	Start your jvm with Aspectj load time
weaver:</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in"><FONT COLOR="#0000ff"><FONT SIZE=1 STYLE="font-size: 8pt">	<FONT SIZE=2 STYLE="font-size: 9pt">-javaagent:${project.build.directory}/lib/aspectjweaver-${aspectj.version}.jar</FONT></FONT></FONT></P>
<P STYLE="margin-bottom: 0in"> 
</P>
<P STYLE="margin-bottom: 0in">	Make sure your aspectj config file
(META-INF/aop.xml) contains:</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-left: 0.49in; margin-bottom: 0in"><FONT COLOR="#0000ff"><FONT SIZE=2 STYLE="font-size: 9pt">&lt;aspectj&gt;</FONT></FONT></P>
<P STYLE="margin-left: 0.49in; margin-bottom: 0in"><FONT COLOR="#0000ff">
   <FONT SIZE=2 STYLE="font-size: 9pt">&lt;aspects&gt;</FONT></FONT></P>
<P STYLE="margin-left: 0.49in; margin-bottom: 0in"><FONT COLOR="#0000ff">
       <FONT SIZE=2 STYLE="font-size: 9pt">&lt;aspect
name=&quot;org.spf4j.perf.aspect.PerformanceMonitorAspect&quot;/&gt;</FONT></FONT></P>
<P STYLE="margin-left: 0.49in; margin-bottom: 0in"><FONT COLOR="#0000ff">
   <FONT SIZE=2 STYLE="font-size: 9pt">&lt;/aspects&gt;</FONT></FONT></P>
<P STYLE="margin-left: 0.49in; margin-bottom: 0in"><FONT COLOR="#0000ff">
   <FONT SIZE=2 STYLE="font-size: 9pt">&lt;weaver options=&quot;-verbose&quot;&gt;</FONT></FONT></P>
<P STYLE="margin-left: 0.49in; margin-bottom: 0in"><FONT COLOR="#0000ff">
       <FONT SIZE=2 STYLE="font-size: 9pt">&lt;include
within=&quot;com.*..*&quot;/&gt;</FONT></FONT></P>
<P STYLE="margin-left: 0.49in; margin-bottom: 0in"><FONT COLOR="#0000ff">
   <FONT SIZE=2 STYLE="font-size: 9pt">&lt;/weaver&gt;</FONT></FONT></P>
<P STYLE="margin-left: 0.49in; margin-bottom: 0in"><FONT COLOR="#0000ff"><FONT SIZE=2 STYLE="font-size: 9pt">&lt;/aspectj&gt;</FONT></FONT></P>
<P STYLE="margin-left: 0.49in; margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-left: 0.49in; margin-bottom: 0in"><FONT COLOR="#000000"><FONT SIZE=3>This
will record the execution times of the annotated method and will also
log (via spf4j) a message containing the call detail and execution
time if the warn or error thresholds are exceeded. Dynamic quantized
recorder source is used.</FONT></FONT></P>
<H2 CLASS="western"><A NAME="__RefHeading__1539_175073954"></A> 4.3.How
to see the recorded measurements?</H2>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in"><FONT COLOR="#0000ff"><FONT SIZE=3><FONT COLOR="#000000">Via
JMX invoke </FONT>spf4j/RRDMeasurementDatabase/generateCharts <FONT COLOR="#000000">this
will generate 2 charts that will contain the recorded measurements:</FONT></FONT></FONT></P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in"><FONT COLOR="#000000"><FONT SIZE=3>a)
min, max, avg , measurement count values/ time axis</FONT></FONT></P>
<P STYLE="margin-bottom: 0in"><IMG SRC="spf4j_html_6e2e48f6.png" NAME="graphics2" ALIGN=LEFT WIDTH=762 HEIGHT=381 BORDER=0><BR CLEAR=LEFT><BR>
</P>
<P STYLE="margin-bottom: 0in">b) Distribution chart, where on the X
axis we have the time, the Y axis we have the recorded values
(buckets) and the number of measurements recorded that fall in a
particular bucket will be represented by the color(values to color
mapping can be seen in the legend). As you can see this is a log
linear chart.</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in"><IMG SRC="spf4j_html_3985c376.png" NAME="graphics6" ALIGN=LEFT WIDTH=762 HEIGHT=381 BORDER=0><BR CLEAR=LEFT><BR>
</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<H2 CLASS="western"><A NAME="__RefHeading__1541_175073954"></A> 4.4.How
does it work ?</H2>
<P><IMG SRC="spf4j_html_m6aa6e8c7.gif" ALIGN=LEFT><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P>Charts are generated using jfreechart library.</P>
<H1 CLASS="western"><A NAME="__RefHeading__1423_175073954"></A> 5.Performance
Profiling</H1>
<H2 CLASS="western"><A NAME="__RefHeading__1543_175073954"></A> 5.1.Why
another profiling library?</H2>
<P>It all started with Brendan Gregg's blog:
<A HREF="http://dtrace.org/blogs/brendan/2011/12/16/flame-graphs/">http://dtrace.org/blogs/brendan/2011/12/16/flame-graphs/</A>
combined with a few hours of coding. However since than more
monitoring capability has been added to spf4j. Aspects to monitor
object allocation, network, file, memory usage have been added.</P>
<H2 CLASS="western"><A NAME="__RefHeading__1545_175073954"></A> 5.2.When
to profile your code?</H2>
<OL>
	<LI><P>I recommend to deploy your code with profiling turned on as
	much as you can. In my case I have profiling data collection turned
	on in test/qa environments all the time. (with 100ms sampling
	interval). If you can afford to do it in PROD do it.</P>
</OL>
<H2 CLASS="western"><A NAME="__RefHeading__1547_175073954"></A> 5.3.How
to profile your code?</H2>
<P> 
</P>
<P>Add spf4j to your classpath and the following to your command
line:</P>
<P><FONT COLOR="#2323dc">  <FONT SIZE=2 STYLE="font-size: 9pt">${JAVA_HOME}/bin/java
[your jvm args] org.spf4j.stackmonitor.Monitor  -f reportFile.html
-ss -si 100 -w 600 -main [your app main class] - -  [your app
arguments]</FONT></FONT></P>
<P>This will start your application with profiling enabled, with a
100 ms sampling interval. After the process ends reportFile.html will
be generated with a graphic width of 600 pixels. Profiling can also
be enabled/disabled via JMX.</P>
<P><FONT COLOR="#2323dc"><FONT SIZE=2 STYLE="font-size: 9pt">Supported
arguments:</FONT></FONT></P>
<P><FONT COLOR="#2323dc"> <FONT SIZE=2 STYLE="font-size: 9pt">-f VAL 
  : output to this file the perf report, format is HTML</FONT></FONT></P>
<P><FONT COLOR="#2323dc"> <FONT SIZE=2 STYLE="font-size: 9pt">-main
VAL : the main class name</FONT></FONT></P>
<P><FONT COLOR="#2323dc"> <FONT SIZE=2 STYLE="font-size: 9pt">-md N  
  : maximum stack trace depth</FONT></FONT></P>
<P><FONT COLOR="#2323dc"> <FONT SIZE=2 STYLE="font-size: 9pt">-nosvg 
  : stack visualization will be in svg format</FONT></FONT></P>
<P><FONT COLOR="#2323dc"> <FONT SIZE=2 STYLE="font-size: 9pt">-si N  
  : the stack sampling interval in milliseconds</FONT></FONT></P>
<P><FONT COLOR="#2323dc"> <FONT SIZE=2 STYLE="font-size: 9pt">-ss    
  : start the stack sampling thread. (can also be done manually via</FONT></FONT></P>
<P><FONT COLOR="#2323dc">             <FONT SIZE=2 STYLE="font-size: 9pt">jmx)</FONT></FONT></P>
<P><FONT COLOR="#2323dc"> <FONT SIZE=2 STYLE="font-size: 9pt">-w N   
  : flame chart width in pixels</FONT></FONT></P>
<H2 CLASS="western"><A NAME="__RefHeading__1549_175073954"></A> 5.4.How
to see the profile data?</H2>
<P>After the program finishes it will write the data to the
reportFile.html</P>
<P><IMG SRC="spf4j_html_m744de76d.png" NAME="graphics4" ALIGN=LEFT WIDTH=469 HEIGHT=341 BORDER=0><BR CLEAR=LEFT>The
total view shows the total picture of what your application is doing.</P>
<P>Now as you can see this profile of my simple test code is sleeping
most of the time. I you are interested into what the process is doing
while it is on CPU, the next report will provide that detail:</P>
<P><IMG SRC="spf4j_html_18e6e8b9.png" NAME="graphics5" ALIGN=LEFT WIDTH=408 HEIGHT=461 BORDER=0><BR CLEAR=LEFT><BR><BR>
</P>
<P>Processes are staying quite a bit waiting for things to
happen/sleeping and there is not much you can do about that,
eliminating those states from the report allows you to see and
concentrate on the “useful” parts of your application. As you can
see above (if you look at the actual reports hovering with the mouse
above a entry will display the details) DemoTest is also doing stuff
(doStuff) not only sleeping...</P>
<H2 CLASS="western"><A NAME="__RefHeading__1551_175073954"></A> 5.5.How
does it work?</H2>
<P><BR><BR>
</P>
<P>A sampling thread is started and running in the background. This
thread uses Thread.getAllStackTraces() or the JVM MX beans
(configurable) to get all stack traces for all threads. Each sample
is added to a tree that aggregates the stack trace data.</P>
<H2 CLASS="western"><A NAME="__RefHeading__1553_175073954"></A> 5.6.Monitoring
memory allocations:</H2>
<P>You will need to apply aspect
org.spf4j.memorymonitor.AllocationMonitorAspect to the code you want
to monitor object allocations. At any time while you process is
running you can generate the memory allocation charts:</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P><IMG SRC="spf4j_html_m12b51f72.png" NAME="graphics1" ALIGN=LEFT WIDTH=762 HEIGHT=381 BORDER=0><BR CLEAR=LEFT><BR><BR>
</P>
<P>Allocations will classified based on the class where they are
done. In the chart above you can see how memory allocations happened,
both byteSize and allocation count and what class. Object size
computation might be too much overhead, in that case you can disable
it by system property setting: perf.allocations.recordSize=false</P>
<H2 CLASS="western"><A NAME="__RefHeading__1555_175073954"></A> 5.7.Monitoring
Network IO</H2>
<P>The aspect org.spf4j.iomonitor.NetworkMonitorAspect will allow you
to monitor you processes network traffic:</P>
<P><IMG SRC="spf4j_html_3b757dc0.png" NAME="graphics3" ALIGN=LEFT WIDTH=762 HEIGHT=381 BORDER=0><BR CLEAR=LEFT><BR><BR>
</P>
<H1 CLASS="western"><A NAME="__RefHeading__1425_175073954"></A> 6.High
Performance Object Pool</H1>
<H2 CLASS="western"><A NAME="__RefHeading__1557_175073954"></A> 6.1.Why
another object pool implementation?</H2>
<P>In my(I am not alone) view current available object pool
implementations are less than perfect. Beside the scalability issues
and bugs, I don't like the following  implementation choices found in
other implementations:</P>
<OL>
	<LI><P>Test on borrow is pointless, there is no guarantee that you
	will get a valid object even if you test on borrow. This encourages
	the developer to disregard handling of this case when it receives an
	invalid object. This practice also often is a performance killer.</P>
	<LI><P>Indiscriminate test on return is not optimal. Test on return
	should be done only in the case where there is a suspicion that the
	object is invalid, otherwise the performance impact will be too high
	to be acceptable in most cases. Pool client should be able to
	provide feedback on return for that case.</P>
	<LI><P>NO exception swallowing. If a exception happens with the
	pooled objects the pool user will know about it and will have to
	handle it.</P>
</OL>
<P STYLE="margin-bottom: 0in">You will not find code like this
(apache commons):</P>
<OL>
	<OL>
		<OL START=0>
			<PRE>
<A NAME="131"></A>  <FONT SIZE=1 STYLE="font-size: 8pt">131 &nbsp;     /**</FONT></PRE>
		</OL>
	</OL>
</OL>
<PRE>  <FONT SIZE=1 STYLE="font-size: 8pt">132 &nbsp;      * Unconditionally close an &lt;code&gt;Reader&lt;/code&gt;.</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">133 &nbsp;      * &lt;p&gt;</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">134 &nbsp;      * Equivalent to {@link Reader#close()}, except any exceptions will be ignored.</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">135 &nbsp;      * This is typically used in finally blocks.</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">136 &nbsp;      *</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">137 &nbsp;      * @param input  the Reader to close, may be null or already closed</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">138 &nbsp;      */</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">139 &nbsp;     public static void closeQuietly(Reader input) {</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">140 &nbsp;         try {</FONT>
<A NAME="141"></A>  <FONT SIZE=1 STYLE="font-size: 8pt">141 &nbsp;             if (input != null) {</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">142 &nbsp;                 input.close();</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">143 &nbsp;             }</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">144 &nbsp;         } catch (IOException ioe) {</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">145 &nbsp;             // ignore</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">146 &nbsp;         }</FONT>
  <FONT SIZE=1 STYLE="font-size: 8pt">147 &nbsp;     }</FONT></PRE>
<OL START=3>
	<P></P>
</OL>
<P>In Guava (my favorite open source library) the authors did the
same mistake as the apache folk above. But I am happy they realized
the problem recently:</P>
<P STYLE="margin-bottom: 0in"><CODE><STRONG><A HREF="http://docs.guava-libraries.googlecode.com/git/javadoc/com/google/common/io/Closeables.html#closeQuietly%28java.io.Closeable%29">closeQuietly</A></STRONG></CODE><CODE>(</CODE><CODE><A HREF="http://download.oracle.com/javase/6/docs/api/java/io/Closeable.html?is-external=true">Closeable</A></CODE><CODE>&nbsp;closeable)</CODE>
</P>
<P STYLE="margin-bottom: 0in"><STRONG>Deprecated.</STRONG>&nbsp; 
</P>
<P STYLE="margin-bottom: 0in"><I>This method has few valid use cases
and encourages misuse by making it easy to do the wrong thing. Among
other things, it may swallow exceptions that really should be thrown,
such as exceptions thrown when closing an output stream: this often
involves flushing buffered data to the final output destination and
as such it is just as important to throw the exception thrown when
closing as it is to throw an exception thrown by a call to a write
method. This method is scheduled to be removed in Guava 16.0.</I></P>
<P><BR><BR>
</P>
<P>In guava they recommend the following pattern for not loosing the
original exception:</P>
<PRE><FONT COLOR="#282b26"> </FONT><FONT COLOR="#282b26"><FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">public void useStreamNicely() throws IOException {</FONT></FONT></FONT>
     <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">SomeStream stream = new SomeStream(&quot;foo&quot;);</FONT></FONT>
     <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">boolean threw = true;</FONT></FONT>
     <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">try {</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">// ... code which does something with the stream ...</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">threw = false;</FONT></FONT>
     <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">} finally {</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">// If an exception occurs, rethrow it only if threw==false:</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">Closeables.close(stream, threw);</FONT></FONT>
     <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">}</FONT></FONT>
   <FONT FACE="American Typewriter, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">}</FONT></FONT>
</PRE><P>
<FONT COLOR="#282b26"><FONT FACE="Times New Roman, serif"><FONT SIZE=3>I
prefer using the exception chaining technique in which case both
exceptions info will be thrown:</FONT></FONT></FONT></P>
<PRE>
<FONT COLOR="#282b26">  </FONT><FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt"><FONT COLOR="#282b26">T object = pool.borrowObject();</FONT></FONT></FONT>
   <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">try {</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">handler.handle(object);</FONT></FONT>
   <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">} catch (Exception e) {</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">try {</FONT></FONT>
           <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">pool.returnObject(object, e);</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">} catch (ObjectReturnException ex) {</FONT></FONT>
           <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">throw Exceptions.chain(ex, e);</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">} catch (ObjectDisposeException ex) {</FONT></FONT>
           <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">throw Exceptions.chain(ex, e);</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">}</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">if (e instanceof RuntimeException) {</FONT></FONT>
           <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">throw (RuntimeException) e;</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">} else {</FONT></FONT>
           <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">throw new RuntimeException(e);</FONT></FONT>
       <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">}</FONT></FONT>
   <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">}</FONT></FONT>
   <FONT FACE="Courier New, monospace"><FONT SIZE=1 STYLE="font-size: 8pt">pool.returnObject(object, null);</FONT></FONT></PRE><P STYLE="margin-bottom: 0in">
<BR>
</P>
<H2 CLASS="western"><A NAME="__RefHeading__1559_175073954"></A> 6.2.Use
case</H2>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P>The classical use case for an object pool is to pool your jdbc
connections. One of the most popular object pool implementations is
apache commons-pool with dbcp-pool specialized in JDBC object based
on it. A lot of people are unhappy with this implementation
(including myself), so much that the apache tomcat developers wrote
their own implementation. Here is a comparison of their
implementation against dbcp pool:</P>
<P><A HREF="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html">http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html</A></P>
<P>A performance comparison between dbcp, c3p0, and tomcat jdbc pool
:</P>
<P><A HREF="http://www.tomcatexpert.com/blog/2010/03/22/understanding-jdbc-pool-performance-improvements">http://www.tomcatexpert.com/blog/2010/03/22/understanding-jdbc-pool-performance-improvements</A></P>
<P>The goal of this implementation is to be more reliable and faster
than any of the implementations out there. (Unit test will fail
otherwise)</P>
<H2 CLASS="western"><A NAME="__RefHeading__1561_175073954"></A> 6.3.How
to use the object pool</H2>
<P>Creating a pool is simple:</P>
<P><FONT SIZE=2>ObjectPool&lt;ExpensiveTestObject&gt; pool = new
ObjectPoolBuilder(10, new ExpensiveTestObjectFactory()).build();</FONT></P>
<P>at minimum you will need to provide the maximum size and the
object factory.</P>
<P>To do something with a object from a pool you will need to:</P>
<P> <FONT SIZE=2>Template.doOnPooledObject(new
ObjectPool.Hook&lt;PooledObject, SomeException&gt;() {</FONT></P>
<P>            <FONT SIZE=2>@Override</FONT></P>
<P>            <FONT SIZE=2>public void handle( PooledObject object)
throws SomeException {</FONT></P>
<P>                <FONT SIZE=2>object.doStuff();</FONT></P>
<P>            <FONT SIZE=2>}</FONT></P>
<P>        <FONT SIZE=2>}, pool, IOException.class);</FONT></P>
<P>You can also use the borrow and return methods on the object pool
to get and return an object to the pool.</P>
<H2 CLASS="western"><A NAME="__RefHeading__1563_175073954"></A> 6.4.How
does the pool work?</H2>
<P><IMG SRC="spf4j_html_m316ad2cd.gif" ALIGN=LEFT><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P>The architecture above biases object to threads, so a thread will
most likely get the same object minimizing object contention (if pool
size &gt;= thread nr which is the recommended sizing). 
</P>
</BODY>
</HTML>